{% extends "base.html" %}
{% block content %}
<h2 class="text-lg font-semibold mb-3">Utlägg</h2>

<form action="/transactions/create" method="post" class="bg-white rounded-xl p-4 shadow space-y-3 mb-4">
  <div>
    <label class="block text-sm">Datum</label>
    <input name="date" type="date" required class="w-full border rounded p-2">
  </div>

  <div>
    <label class="block text-sm">Kategori</label>
    <input name="category" placeholder="Mat, Hyra, ..." required class="w-full border rounded p-2">
  </div>

  <div>
    <label class="block text-sm">Beskrivning</label>
    <input name="description" class="w-full border rounded p-2">
  </div>

  <div>
    <label class="block text-sm">Belopp (kr)</label>
    <input id="amount_input" name="amount" type="number" step="0.01" required class="w-full border rounded p-2">
  </div>

  <div>
    <label class="block text-sm">Betalare</label>
    <select id="payer_select" name="payer_member_id" class="w-full border rounded p-2" required>
      {% for m in members %}
        <option value="{{ m.id }}"
                data-role="{{ 'lukas' if m.display_name|lower == 'lukas' else 'partner' }}"
                data-name="{{ m.display_name }}">{{ m.display_name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="flex items-center gap-2">
    <input id="chk_shared" name="is_shared" type="checkbox" value="true" class="h-4 w-4">
    <label for="chk_shared">Gemensam?</label>
  </div>

  <div>
    <label class="block text-sm">Delningsmetod</label>
    <select id="split_method" name="split_method" class="w-full border rounded p-2">
      <option value="equal">Lika (50/50)</option>
      <option value="percent">Procent (för betalaren)</option>
      <option value="fixed">Fast belopp</option>
    </select>
  </div>

  <!-- Procent (alltid för betalaren) -->
  <div id="row_percent" class="hidden">
    <label id="percent_label" class="block text-sm">Procent (0–1)</label>
    <input id="percent_input" name="percent_raw" type="number" step="0.01" inputmode="decimal" class="w-full border rounded p-2">
    <input type="hidden" id="percent_target" name="percent_target" value=""> <!-- 'lukas' eller 'annie' -->
    <p class="text-xs text-gray-600 mt-1">Ex: 0.7 = 70% för betalaren.</p>
  </div>

  <!-- Fast belopp -->
  <div id="row_fixed" class="hidden space-y-2">
    <div>
      <label class="block text-sm">Vem gäller beloppet?</label>
      <select id="fixed_target" name="fixed_target" class="w-full border rounded p-2">
        <option value="lukas">Lukas</option>
        <option value="annie">Annie</option>
      </select>
    </div>
    <div>
      <label id="fixed_label" class="block text-sm">Fast belopp (kr)</label>
      <input id="fixed_input" name="fixed_raw" type="number" step="0.01" inputmode="decimal" class="w-full border rounded p-2">
      <p class="text-xs text-gray-600 mt-1">Beloppet tolkas för vald person. Ex: väljer du “Annie = 300”, så blir Lukas del = (Belopp − 300).</p>
    </div>
  </div>

  <button class="w-full bg-black text-white rounded-xl py-2 font-semibold">Spara</button>
</form>

<script>
  function currentPayerRole() {
    const sel = document.getElementById('payer_select');
    const opt = sel.options[sel.selectedIndex];
    return opt.getAttribute('data-role'); // 'lukas' eller 'partner' (partner = Annie)
  }
  function currentPayerName() {
    const sel = document.getElementById('payer_select');
    const opt = sel.options[sel.selectedIndex];
    return opt.getAttribute('data-name'); // visningsnamn: Lukas/Annie
  }

  function updateSplitFields() {
    const method = document.getElementById('split_method').value;

    const rowPercent = document.getElementById('row_percent');
    const rowFixed   = document.getElementById('row_fixed');

    const inputPercent = document.getElementById('percent_input');
    const inputFixed   = document.getElementById('fixed_input');

    // Dölj & disable allt först
    [rowPercent, rowFixed].forEach(el => el.classList.add('hidden'));
    [inputPercent, inputFixed].forEach(inp => { inp.disabled = true; if (document.activeElement !== inp) inp.value = ""; });

    // Uppdatera labels/targets utifrån betalare
    const role = currentPayerRole();                 // 'lukas' eller 'partner'
    const name = currentPayerName();                 // t.ex. "Annie" eller "Lukas"
    const percentTarget = document.getElementById('percent_target');
    const percentLabel  = document.getElementById('percent_label');
    const fixedLabel    = document.getElementById('fixed_label');
    const fixedTargetEl = document.getElementById('fixed_target');

    if (method === 'percent') {
      // Procent gäller alltid betalaren
      rowPercent.classList.remove('hidden');
      inputPercent.disabled = false;
      percentTarget.value = (role === 'lukas') ? 'lukas' : 'annie';
      percentLabel.textContent = `Procent ${name} (0–1)`;
    } else if (method === 'fixed') {
      rowFixed.classList.remove('hidden');
      inputFixed.disabled = false;
      // Default: beloppet gäller betalaren (kan ändras i selecten)
      fixedTargetEl.value = (role === 'lukas') ? 'lukas' : 'annie';
      fixedLabel.textContent = `Fast belopp (${fixedTargetEl.value === 'lukas' ? 'Lukas' : 'Annie'})`;
    }

    // När man ändrar “Vem gäller beloppet?”
    fixedTargetEl.onchange = () => {
      fixedLabel.textContent = `Fast belopp (${fixedTargetEl.value === 'lukas' ? 'Lukas' : 'Annie'})`;
    };
  }

  document.getElementById('split_method').addEventListener('change', updateSplitFields);
  document.getElementById('payer_select').addEventListener('change', updateSplitFields);
  document.addEventListener('DOMContentLoaded', updateSplitFields);
</script>


<div class="bg-white rounded-xl p-4 shadow">
  <h3 class="font-semibold mb-2">Senaste utlägg</h3>
  <div class="space-y-2">
    {% for t in txs %}
      <div class="flex justify-between text-sm border-b pb-1">
        <div>
          <div class="font-medium">{{ t.category }} – {{ t.amount }} kr</div>
          <div class="text-gray-600">{{ t.date }} · {{ t.description or "" }}</div>
        </div>
        <div class="text-right text-gray-600">
            <div>Betalare: {{ payer_map.get(t.payer_member_id, '#' ~ t.payer_member_id) }}</div>
              <div>{{ "Gemensam" if t.is_shared else "Privat" }}</div>
        </div>

      </div>
    {% else %}
      <div class="text-gray-500">Inga utlägg ännu.</div>
    {% endfor %}
  </div>
</div>

<script>
  function updateSplitFields() {
    const method = document.getElementById('split_method').value;

    const rowPercent = document.getElementById('row_percent');
    const rowFixed   = document.getElementById('row_fixed');

    const inputPercent = document.getElementById('percent_input');
    const inputFixed   = document.getElementById('fixed_input');

    // Dölj/töm/disable alla först
    [rowPercent, rowFixed].forEach(el => el.classList.add('hidden'));
    [inputPercent, inputFixed].forEach(inp => { 
      inp.disabled = true; 
      // töm värde när fältet döljs (hindrar "spökdata")
      if (document.activeElement !== inp) inp.value = ""; 
    });

    // Visa rätt fält beroende på metod
    if (method === 'percent') {
      rowPercent.classList.remove('hidden');
      inputPercent.disabled = false;
      inputPercent.placeholder = "t.ex. 0.5 (50%)";
    } else if (method === 'fixed') {
      rowFixed.classList.remove('hidden');
      inputFixed.disabled = false;
      inputFixed.placeholder = "t.ex. 250";
    }
  }

  document.getElementById('split_method').addEventListener('change', updateSplitFields);
  // Kör vid sidladdning också
  document.addEventListener('DOMContentLoaded', updateSplitFields);
</script>


{% endblock %}
